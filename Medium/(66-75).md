## 66. Use CTE to calculate running total of sales per month

```sql
WITH MonthlySales AS (
    SELECT 
        DATE_FORMAT(order_date, '%Y-%m') AS month,
        SUM(total_amount) AS monthly_sales
    FROM Orders
    WHERE status = 'Delivered'
    GROUP BY month
)
SELECT 
    month, 
    monthly_sales,
    SUM(monthly_sales) OVER (ORDER BY month) AS running_total
FROM MonthlySales
ORDER BY month;
````

---

## 67. Find top 3 products per category using CTE with ROW_NUMBER

```sql id="pr7k21"
WITH ProductRanking AS (
    SELECT 
        p.category_id, 
        p.product_id, 
        p.product_name, 
        SUM(oi.quantity) AS total_sold,
        ROW_NUMBER() OVER (
            PARTITION BY p.category_id 
            ORDER BY SUM(oi.quantity) DESC
        ) AS rank_num
    FROM Products p
    LEFT JOIN Order_Items oi 
        ON p.product_id = oi.product_id
    GROUP BY 
        p.category_id, 
        p.product_id, 
        p.product_name
)
SELECT 
    c.category_name, 
    pr.product_name, 
    pr.total_sold, 
    pr.rank_num
FROM ProductRanking pr
JOIN Categories c 
    ON pr.category_id = c.category_id
WHERE pr.rank_num <= 3 
  AND pr.total_sold IS NOT NULL
ORDER BY c.category_name, pr.rank_num;
```

---

## 68. Calculate customer lifetime value using CTE

```sql id="kl4p9s"
WITH CustomerOrders AS (
    SELECT 
        c.customer_id, 
        c.first_name, 
        c.last_name,
        COUNT(o.order_id) AS total_orders,
        SUM(o.total_amount) AS total_spent,
        MIN(o.order_date) AS first_order,
        MAX(o.order_date) AS last_order
    FROM Customers c
    LEFT JOIN Orders o 
        ON c.customer_id = o.customer_id 
       AND o.status = 'Delivered'
    GROUP BY 
        c.customer_id, 
        c.first_name, 
        c.last_name
)
SELECT 
    customer_id, 
    first_name, 
    last_name, 
    total_orders, 
    total_spent,
    DATEDIFF(
        COALESCE(last_order, CURDATE()), 
        COALESCE(first_order, CURDATE())
    ) AS customer_lifetime_days,
    ROUND(
        total_spent / NULLIF(
            DATEDIFF(
                COALESCE(last_order, CURDATE()), 
                COALESCE(first_order, CURDATE())
            ), 
            0
        ) * 30, 
        2
    ) AS monthly_avg_spend
FROM CustomerOrders
WHERE total_orders > 0
ORDER BY total_spent DESC;
```

---

## 69. Identify product pairs frequently bought together

```sql id="mt8q0x"
WITH OrderPairs AS (
    SELECT 
        oi1.order_id, 
        oi1.product_id AS product1_id,
        oi2.product_id AS product2_id
    FROM Order_Items oi1
    JOIN Order_Items oi2 
        ON oi1.order_id = oi2.order_id 
       AND oi1.product_id < oi2.product_id
)
SELECT 
    p1.product_name AS product_1, 
    p2.product_name AS product_2,
    COUNT(*) AS times_bought_together
FROM OrderPairs op
JOIN Products p1 
    ON op.product1_id = p1.product_id
JOIN Products p2 
    ON op.product2_id = p2.product_id
GROUP BY 
    p1.product_name, 
    p2.product_name
ORDER BY times_bought_together DESC
LIMIT 5;
```

---

## 70. Compute moving average of daily sales using CTE

```sql id="wr3t8v"
WITH DailySales AS (
    SELECT 
        DATE(order_date) AS sale_date,
        SUM(total_amount) AS daily_total
    FROM Orders
    WHERE status = 'Delivered'
    GROUP BY DATE(order_date)
)
SELECT 
    sale_date, 
    daily_total,
    ROUND(
        AVG(daily_total) OVER (
            ORDER BY sale_date 
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        ), 
        2
    ) AS moving_avg_3days
FROM DailySales
ORDER BY sale_date;
```

---

## 71. Find customers with consecutive orders in multiple months

```sql id="p9k2zf"
WITH CustomerMonths AS (
    SELECT DISTINCT 
        customer_id,
        DATE_FORMAT(order_date, '%Y-%m') AS order_month
    FROM Orders
),
CustomerWithPrev AS (
    SELECT 
        customer_id, 
        order_month,
        LAG(order_month) OVER (
            PARTITION BY customer_id 
            ORDER BY order_month
        ) AS prev_month
    FROM CustomerMonths
)
SELECT 
    c.customer_id, 
    c.first_name, 
    c.last_name,
    COUNT(*) AS consecutive_months
FROM CustomerWithPrev cm
JOIN Customers c 
    ON cm.customer_id = c.customer_id
WHERE cm.prev_month = DATE_FORMAT(
    DATE_SUB(
        STR_TO_DATE(CONCAT(cm.order_month, '-01'), '%Y-%m-%d'), 
        INTERVAL 1 MONTH
    ), 
    '%Y-%m'
)
GROUP BY 
    c.customer_id, 
    c.first_name, 
    c.last_name;
```

---

## 72. Calculate category contribution to total sales using CTE

```sql id="6lv8uy"
WITH CategorySales AS (
    SELECT 
        c.category_id, 
        c.category_name,
        SUM(oi.quantity * oi.price) AS category_sales
    FROM Categories c
    LEFT JOIN Products p 
        ON c.category_id = p.category_id
    LEFT JOIN Order_Items oi 
        ON p.product_id = oi.product_id
    GROUP BY 
        c.category_id, 
        c.category_name
),
TotalSales AS (
    SELECT 
        SUM(category_sales) AS grand_total
    FROM CategorySales
)
SELECT 
    cs.category_name, 
    ROUND(cs.category_sales, 2) AS category_sales,
    ROUND(
        100.0 * cs.category_sales / ts.grand_total, 
        2
    ) AS sales_percentage
FROM CategorySales cs
CROSS JOIN TotalSales ts
WHERE cs.category_sales > 0
ORDER BY sales_percentage DESC;
```

---

## 73. Identify best-selling month for each product category

```sql id="t3x8qn"
WITH MonthlyCategorySales AS (
    SELECT 
        c.category_id, 
        c.category_name,
        DATE_FORMAT(o.order_date, '%Y-%m') AS sale_month,
        SUM(oi.quantity * oi.price) AS monthly_sales
    FROM Categories c
    JOIN Products p 
        ON c.category_id = p.category_id
    JOIN Order_Items oi 
        ON p.product_id = oi.product_id
    JOIN Orders o 
        ON oi.order_id = o.order_id
    WHERE o.status = 'Delivered'
    GROUP BY 
        c.category_id, 
        c.category_name, 
        sale_month
),
RankedSales AS (
    SELECT *,
        ROW_NUMBER() OVER (
            PARTITION BY category_id 
            ORDER BY monthly_sales DESC
        ) AS rn
    FROM MonthlyCategorySales
)
SELECT 
    category_name, 
    sale_month, 
    ROUND(monthly_sales, 2) AS best_month_sales
FROM RankedSales
WHERE rn = 1
ORDER BY best_month_sales DESC;
```

---

## 74. Show customer retention rate by month using CTE

```sql id="y6mr2p"
WITH FirstOrders AS (
    SELECT 
        customer_id, 
        MIN(DATE_FORMAT(order_date, '%Y-%m')) AS first_month
    FROM Orders
    GROUP BY customer_id
),
MonthlyActivity AS (
    SELECT DISTINCT 
        customer_id, 
        DATE_FORMAT(order_date, '%Y-%m') AS active_month
    FROM Orders
)
SELECT 
    fa.first_month,
    COUNT(DISTINCT fa.customer_id) AS new_customers,
    COUNT(DISTINCT ma.customer_id) AS retained_customers,
    ROUND(
        100.0 * COUNT(DISTINCT ma.customer_id) 
        / COUNT(DISTINCT fa.customer_id), 
        2
    ) AS retention_rate
FROM FirstOrders fa
LEFT JOIN MonthlyActivity ma 
    ON fa.customer_id = ma.customer_id 
   AND ma.active_month = DATE_FORMAT(
        DATE_ADD(
            STR_TO_DATE(CONCAT(fa.first_month, '-01'), '%Y-%m-%d'), 
            INTERVAL 1 MONTH
        ), 
        '%Y-%m'
   )
GROUP BY fa.first_month
ORDER BY fa.first_month;
```

---

## 75. Calculate average time between orders for repeat customers

```sql id="n4zw81"
WITH CustomerOrders AS (
    SELECT 
        customer_id, 
        order_date,
        LEAD(order_date) OVER (
            PARTITION BY customer_id 
            ORDER BY order_date
        ) AS next_order_date
    FROM Orders
    WHERE status = 'Delivered'
),
OrderGaps AS (
    SELECT 
        customer_id,
        DATEDIFF(next_order_date, order_date) AS days_between_orders
    FROM CustomerOrders
    WHERE next_order_date IS NOT NULL
)
SELECT 
    c.customer_id, 
    c.first_name, 
    c.last_name,
    COUNT(*) AS repeat_purchase_count,
    ROUND(AVG(days_between_orders), 0) AS avg_days_between_orders
FROM OrderGaps og
JOIN Customers c 
    ON og.customer_id = c.customer_id
GROUP BY 
    c.customer_id, 
    c.first_name, 
    c.last_name
ORDER BY avg_days_between_orders;
```
